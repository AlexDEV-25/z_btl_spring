<app-layout [menuItems]="menuItems" [userName]="userName" [userRole]="'Giáº£ng viÃªn'">
  <div class="main-card">
    <div class="page-header">
      <h3>ğŸ“ Cháº¥m Ä‘iá»ƒm sinh viÃªn</h3>
      <div class="header-controls">
        <select class="semester-select" [(ngModel)]="selectedSemester" (change)="onSemesterChange()">
          <option *ngFor="let semester of availableSemesters" [value]="semester.semester">
            {{ semester.displayName }}
          </option>
        </select>
      </div>
    </div>

    <!-- Class Selection Card -->
    <div class="card">
      <div class="card-header">
        <h4>ğŸ¯ Chá»n lá»›p há»c</h4>
      </div>
      <div class="card-body">
        <div *ngIf="error" class="alert alert-danger">
          âš ï¸ {{ error }}
        </div>
        <div *ngIf="loading" class="alert alert-info">
          â³ Äang táº£i dá»¯ liá»‡u...
        </div>
        <div *ngIf="!loading && classes.length === 0" class="alert alert-warning">
          ğŸ’­ ChÆ°a cÃ³ lá»›p há»c nÃ o Ä‘Æ°á»£c phÃ¢n cÃ´ng
        </div>

        <div *ngIf="!loading && classes.length > 0" class="classes-grid">
          <div *ngFor="let classInfo of classes" class="class-card"
            [class.selected]="selectedClass?.teachingId === classInfo.teachingId" (click)="selectClass(classInfo)">
            <div class="class-header">
              <h5>{{ classInfo.courseCode }}</h5>
              <span class="class-credits">ğŸ¯ {{ classInfo.credit }} tÃ­n chá»‰</span>
            </div>
            <div class="class-name">
              {{ classInfo.courseName }}
            </div>
            <div class="class-progress">
              <div class="progress-info">
                <span>ğŸ“Š Tiáº¿n Ä‘á»™: {{ getGradedCount(classInfo.students) }}/{{ getTotalCount(classInfo.students)
                  }}</span>
                <span class="percentage">{{ getProgressPercentage(classInfo.students) }}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getProgressPercentage(classInfo.students)"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grading Interface -->
    <div *ngIf="selectedClass" class="card">
      <div class="card-header">
        <h4>ğŸ“ Cháº¥m Ä‘iá»ƒm - {{ selectedClass.courseCode }}</h4>
        <div class="grading-stats">
          <span class="stat-item">
            ğŸ“Š Tiáº¿n Ä‘á»™: {{ getGradedCount(selectedClass.students) }}/{{ getTotalCount(selectedClass.students) }}
          </span>
          <span class="stat-item">
            ğŸ¯ {{ getProgressPercentage(selectedClass.students) }}% hoÃ n thÃ nh
          </span>
        </div>
      </div>

      <div class="card-body">
        <div *ngIf="saveMessage" class="alert" [class.alert-success]="saveMessage.includes('thÃ nh cÃ´ng')"
          [class.alert-danger]="saveMessage.includes('Lá»—i')">
          {{ saveMessage }}
        </div>

        <div class="grading-actions" *ngIf="selectedClass.students.length > 0">
          <button class="btn btn-primary" (click)="saveAllScores()" [disabled]="saving">
            ğŸ’¾ LÆ°u táº¥t cáº£ Ä‘iá»ƒm
          </button>
          <button class="btn btn-secondary" (click)="exportGrades()">
            ğŸ“„ Xuáº¥t báº£ng Ä‘iá»ƒm
          </button>
        </div>

        <div class="table-responsive" *ngIf="selectedClass.students.length > 0">
          <table class="data-table grading-table">
            <thead>
              <tr>
                <th>#</th>
                <th>ğŸ·ï¸ MÃ£ SV</th>
                <th>ğŸ‘¤ Há» tÃªn</th>
                <th>ğŸ“§ Email</th>
                <th>ğŸ§® TP1 (0-10)</th>
                <th>ğŸ§® TP2 (0-10)</th>
                <th>ğŸ“ Thi CK (0-10)</th>
                <th>ğŸ¯ Äiá»ƒm tá»•ng</th>
                <th>âš™ï¸ Thao tÃ¡c</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let student of selectedClass.students; let i = index" [class.graded-row]="student.grade">
                <td><strong>{{ i + 1 }}</strong></td>
                <td><strong>{{ student.studentCode }}</strong></td>
                <td>{{ student.fullName }}</td>
                <td>{{ student.email }}</td>
                <td>
                  <input type="number" class="score-input" min="0" max="10" step="0.1"
                    [(ngModel)]="student.componentScore1" placeholder="0.0" (blur)="calculateGrade(student)" />
                </td>
                <td>
                  <input type="number" class="score-input" min="0" max="10" step="0.1"
                    [(ngModel)]="student.componentScore2" placeholder="0.0" (blur)="calculateGrade(student)" />
                </td>
                <td>
                  <input type="number" class="score-input" min="0" max="10" step="0.1"
                    [(ngModel)]="student.finalExamScore" placeholder="0.0" (blur)="calculateGrade(student)" />
                </td>
                <td>
                  <span class="grade-display" [class.has-grade]="student.grade">
                    {{ student.grade || 'ChÆ°a cháº¥m' }}
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-success" (click)="saveScores(student)" [disabled]="saving"
                    [class.loading]="saving">
                    <span *ngIf="!saving">ğŸ’¾ LÆ°u</span>
                    <span *ngIf="saving">â³ Äang lÆ°u...</span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="selectedClass.students.length === 0" class="alert alert-info">
          ğŸ’­ KhÃ´ng cÃ³ sinh viÃªn nÃ o trong lá»›p há»c nÃ y
        </div>
      </div>
    </div>
  </div>
</app-layout>